// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  HOST
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum CallStatus {
  PENDING
  ONGOING
  COMPLETED
  CANCELLED
}

enum CallType {
  ONE_TO_ONE
  PARTY
}

enum TransactionType {
  PURCHASE
  GIFT_SENT
  GIFT_RECEIVED
  WITHDRAWAL
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum KYCStatus {
  NOT_SUBMITTED
  PENDING
  APPROVED
  REJECTED
}

enum OTPType {
  EMAIL_VERIFICATION
  PHONE_VERIFICATION
  LOGIN
  PASSWORD_RESET
}

enum PaymentStatus {
  CREATED
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentProvider {
  RAZORPAY
  STRIPE
  MOCK  // For development/testing
}

model User {
  id              String      @id @default(cuid())
  
  // Auth fields
  email           String?     @unique
  emailVerified   Boolean     @default(false)
  phoneNumber     String?     @unique
  phoneVerified   Boolean     @default(false)
  passwordHash    String?     // Optional: for email/password auth
  
  // Profile
  username        String      @unique
  displayName     String?
  avatar          String?
  bio             String?
  dateOfBirth     DateTime?   // Required for age validation (>=18)
  gender          String?
  country         String?
  
  // Role & Status
  role            UserRole    @default(USER)
  status          UserStatus  @default(ACTIVE)
  isHost          Boolean     @default(false)
  
  // Agency relationship
  agencyId        String?
  agency          Agency?     @relation(fields: [agencyId], references: [id])
  
  // Gamification
  level           Int         @default(1)
  experience      Int         @default(0)
  
  // Currency
  diamonds        Int         @default(0)
  
  // Stats
  totalCallsMade  Int         @default(0)
  totalGiftsSent  Int         @default(0)
  totalGiftsReceived Int      @default(0)
  
  // KYC Fields
  kycStatus       KYCStatus   @default(NOT_SUBMITTED)
  kycFullName     String?
  kycDocumentType String?     // "passport", "driving_license", "aadhar"
  kycDocumentNumber String?
  kycDocumentFront String?    // Document image URL
  kycDocumentBack  String?    // Document image URL
  kycSelfie       String?     // Selfie URL for verification
  kycAddress      String?
  kycCity         String?
  kycState        String?
  kycPostalCode   String?
  kycSubmittedAt  DateTime?
  kycApprovedAt   DateTime?
  kycRejectedAt   DateTime?
  kycRejectionReason String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  lastLoginAt     DateTime?
  
  // Relations
  hostProfile     HostProfile?
  wallet          Wallet?
  refreshTokens   RefreshToken[]
  otpCodes        OTPCode[]
  callsInitiated  Call[]      @relation("CallInitiator")
  callsReceived   Call[]      @relation("CallReceiver")
  callParticipants CallParticipant[]
  transactions    Transaction[]
  paymentOrders   PaymentOrder[]
  giftsGiven      Gift[]      @relation("GiftGiver")
  giftsReceived   Gift[]      @relation("GiftReceiver")
  withdrawals     Withdrawal[]
  
  @@index([email])
  @@index([phoneNumber])
  @@index([username])
  @@index([agencyId])
}

model Agency {
  id              String      @id @default(cuid())
  
  name            String
  code            String      @unique // Unique code for hosts to join
  email           String      @unique
  phoneNumber     String?
  
  // Commission settings
  commissionRate  Float       @default(10.0) // percentage
  
  // Contact & Details
  contactPerson   String?
  address         String?
  
  // Status
  isActive        Boolean     @default(true)
  
  // Stats
  totalHosts      Int         @default(0)
  totalEarnings   Int         @default(0) // in diamonds
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  hosts           User[]
  
  @@index([code])
  @@index([email])
}

model Wallet {
  id              String      @id @default(cuid())
  userId          String      @unique
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Balances
  availableBalance Int        @default(0) // withdrawable amount in diamonds
  pendingBalance   Int        @default(0) // pending clearance
  totalEarned      Int        @default(0) // lifetime earnings
  totalWithdrawn   Int        @default(0) // lifetime withdrawals
  
  // Bank details (encrypted in production)
  bankDetails     Json?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([userId])
}

model RefreshToken {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  tokenHash       String      @unique // hashed refresh token
  
  expiresAt       DateTime
  createdAt       DateTime    @default(now())
  
  // Device/session info
  userAgent       String?
  ipAddress       String?
  
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model OTPCode {
  id              String      @id @default(cuid())
  userId          String?
  user            User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Contact info (for users not yet registered)
  email           String?
  phoneNumber     String?
  
  code            String      // OTP code (hashed in production)
  type            OTPType
  
  verified        Boolean     @default(false)
  attempts        Int         @default(0)
  
  expiresAt       DateTime
  createdAt       DateTime    @default(now())
  
  @@index([email])
  @@index([phoneNumber])
  @@index([userId])
  @@index([expiresAt])
}

model HostProfile {
  id              String      @id @default(cuid())
  userId          String      @unique
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Host specific
  hourlyRate      Int         @default(0) // in diamonds
  totalEarnings   Int         @default(0) // in diamonds
  availableBalance Int        @default(0) // withdrawable amount
  
  // Stats
  totalCalls      Int         @default(0)
  totalMinutes    Int         @default(0)
  rating          Float       @default(0)
  totalReviews    Int         @default(0)
  
  // KYC
  kycStatus       KYCStatus   @default(NOT_SUBMITTED)
  kycDocuments    Json?
  
  // Bank details (encrypted)
  bankDetails     Json?
  
  isOnline        Boolean     @default(false)
  isBusy          Boolean     @default(false)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([userId])
}

model Call {
  id              String      @id @default(cuid())
  
  callerId        String
  caller          User        @relation("CallInitiator", fields: [callerId], references: [id])
  
  receiverId      String?
  receiver        User?       @relation("CallReceiver", fields: [receiverId], references: [id])
  
  type            CallType
  status          CallStatus  @default(PENDING)
  
  // Agora/Zego session
  channelName     String      @unique
  token           String?
  
  startedAt       DateTime?
  endedAt         DateTime?
  duration        Int         @default(0) // in seconds
  
  // Cost
  diamondsCharged Int         @default(0)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  participants    CallParticipant[]
  gifts           Gift[]
  
  @@index([callerId])
  @@index([receiverId])
  @@index([status])
  @@index([createdAt])
}

model CallParticipant {
  id              String      @id @default(cuid())
  
  callId          String
  call            Call        @relation(fields: [callId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  
  joinedAt        DateTime    @default(now())
  leftAt          DateTime?
  
  @@unique([callId, userId])
  @@index([callId])
  @@index([userId])
}

model Gift {
  id              String      @id @default(cuid())
  
  giverId         String
  giver           User        @relation("GiftGiver", fields: [giverId], references: [id])
  
  receiverId      String
  receiver        User        @relation("GiftReceiver", fields: [receiverId], references: [id])
  
  callId          String?
  call            Call?       @relation(fields: [callId], references: [id])
  
  giftType        String      // e.g., "rose", "car", "yacht"
  diamondValue    Int
  
  message         String?
  
  createdAt       DateTime    @default(now())
  
  @@index([giverId])
  @@index([receiverId])
  @@index([callId])
  @@index([createdAt])
}

model Transaction {
  id              String            @id @default(cuid())
  
  userId          String
  user            User              @relation(fields: [userId], references: [id])
  
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  
  amount          Int               // in diamonds or INR (cents)
  currency        String            @default("INR")
  
  // Payment gateway details
  razorpayOrderId   String?         @unique
  razorpayPaymentId String?         @unique
  razorpaySignature String?
  
  // Idempotency
  idempotencyKey  String?           @unique
  
  description     String?
  metadata        Json?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([idempotencyKey])
}

model PaymentOrder {
  id              String            @id @default(cuid())
  
  userId          String
  user            User              @relation(fields: [userId], references: [id])
  
  provider        PaymentProvider   @default(MOCK)
  status          PaymentStatus     @default(CREATED)
  
  // Amount details
  amount          Int               // in smallest currency unit (paise for INR, cents for USD)
  currency        String            @default("INR")
  diamonds        Int               // diamonds to be credited
  
  // Provider-specific IDs
  providerOrderId   String?         @unique  // e.g., Razorpay order_id
  providerPaymentId String?         @unique  // e.g., Razorpay payment_id
  providerSignature String?
  
  // Idempotency
  idempotencyKey  String?           @unique
  
  // Payment details
  receipt         String?           // receipt number
  notes           Json?
  
  // Status tracking
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  completedAt     DateTime?
  failedAt        DateTime?
  failureReason   String?
  
  @@index([userId])
  @@index([status])
  @@index([providerOrderId])
  @@index([idempotencyKey])
  @@index([createdAt])
}

model Withdrawal {
  id              String            @id @default(cuid())
  
  userId          String
  user            User              @relation(fields: [userId], references: [id])
  
  amount          Int               // in INR (cents)
  diamonds        Int               // diamonds to withdraw
  
  status          WithdrawalStatus  @default(PENDING)
  
  bankDetails     Json              // account details for transfer
  
  processedAt     DateTime?
  rejectionReason String?
  
  transactionRef  String?           @unique
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

